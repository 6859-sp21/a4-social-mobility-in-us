<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <!-- <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> -->
    <!-- <script src="https://cdnjs.com/libraries/d3-legend"></script> -->
    <!-- <script src="https://api.observablehq.com/@d3/color-legend.js?v=3"></script> -->



    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <h1 style="font-size: 3vw;">6.859: Social Mobility in the US College System</h1>

    <div class="grid-container">
      <div class="flourish-embed flourish-chart" data-src="visualisation/5836846" data-height="100%"><script src="https://public.flourish.studio/resources/embed.js"></script></div>

      <div class="IntroText">
        <p> US states present different opportunities for social mobility (Figure 1). <br><br>
          This website intends to provide you with a tool to better understand the heterogeneity in the degree of social mobility that US colleges provide and related factors. <br><br>
          The visualization is based on data by the Opportunity Insights project at Harvard University which defines social mobility as the percentage of students who rose to the top quintile of earners given their parents were in the bottom quitile. <br><br>
          The interactive tool below will allow you to explore this issue at the college level. <br><br>
          <b>Each point in the map represents a college, and is colored based on social mobility. The national median is yellow, red points are below the median and green points are above. More red is further below. More green is further above.</b>
        </p>
      </div>

      <div class="SearchboxDesc">
        <p>Select a school by typing in the searchbox and pressing enter or by hovering your mousing over a point. Clicking on the white background of the map or the "Reset Zoom" button will reset your search. </p>
        <input type="text" value="" id="search_box" style="width:50%;" placeholder="Search for schools..."/>
        <!-- <button id = "search_button"type="button">Update Charts</button> -->
        <button id = "reset_button"type="button" style="float: right;">Reset Zoom</button>
      </div>

      <div class="Map" style="border:1px solid black;"></div>
      <!-- <div class="Map" style="width:975px;height:610px;border:1px solid black;"></div> -->
      <div class="RaceDemographics"></div>
      <div class="MajorDist"></div>
      <div class="SchoolLabel">
        <p>School:</p>
        <p id="school-label">None</>
      </div>
      <div class="TierLabel">
        <p>Tier:</p>
        <p id="tier-label">None</>
      </div>
      <div class="StateLabel">
        <p>State:</p>
        <p id="state-label">None</>
      </div>

      <div class="SocialMobility"></div>
      <div class="StickerPrice"></div>
      <div class="ParentsIncome"></div>
      <div class="Captions">
        <p>The charts to the right of the map show the racial demographics and the distribution over categories of majors for the selected school.</p>
        <p>The charts below show a comparison between a given school (the dashed line) and the average within the tier, state, and whole US.</p>

      </div>
    </div>

    <!-- <div class="Map" id="chart" style="width:975px;height:610px;border:1px solid black;"> -->
      <!-- This is where we will put our chart. -->
    <!-- </div> -->

    <script>

    var search_box_text = "";
    var selected_state = "";
    var selected_point = null;
    var zoom_factor = 1;
    var big_r = 3;
    var small_r = 1;


    function filter_searchbox(d, text = search_box_text) {
        return d.name.toLowerCase().includes(text.toLowerCase())
    }

    function filter_state(d, state = selected_state) {
        return selected_state == "" ? true : d.state_name == selected_state
    }



      // Load data from a URL. You can also have the json file downloaded.
      // See https://github.com/d3/d3/blob/master/API.md#fetches-d3-fetch for more options.
      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-social-mobility-in-us/main/final_dataset.csv").then((college_mobility) => {

        const path = d3.geoPath()
        var us; // = await d3.json("https://static.observableusercontent.com/files/75faaaca1f1a4f415145b9db520349a3a0b93a53c1071346a30e6824586a7c251f45367d9262ed148b7a2b5c2694aa7703f3ac88051abc65066fd0074fdf9c9e?response-content-disposition=attachment%3Bfilename*%3DUTF-8%27%27states-albers-10m.json")
        $.ajax({
          dataType: "json",
          url: "https://raw.githubusercontent.com/6859-sp21/a4-social-mobility-in-us/main/states-albers-10m.json",
          // data: data,
          success: (data, success) => {if (success) us = data;
                                       else console.log("FAILED TO LOAD US MAP")},
          async: false
        });

        const projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305])

        for (const d of college_mobility) {

          d.projection = projection([d.longitude, d.latitude]);

          // if (d.projection ===  null) {
          //   console.log(d.projection)

        }

        college_mobility = college_mobility.filter(d => d.projection !==  null)
        console.log("college_mobility")
        console.log(college_mobility)

        // console.log(us)

        // 1. Filtering our data
        const data = college_mobility//.filter(d => d.count > 200);

        // 2. Setting up variables that describe our map's space.
        const width = 975;
        const height = 610;

        var tip_div = d3.select("body")
                  		    .append("div")
                      		.attr("class", "d3-tip")
                      		.style("opacity", 0)
                          .style("position", "absolute");

        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

        const svg = d3.create("svg")
            .attr("viewBox", [0, 0, width, height])
            .on("click", reset);

        const g = svg.append("g")
          .attr("stroke", "white")
          .attr("cursor", "grab");


        const states = g.append("g")
            .attr("fill", "#444")
            .attr("cursor", "pointer")
          .selectAll("path")
          .data(topojson.feature(us, us.objects.states).features)
          .join("path")
            .on("click", clicked)
            .attr("d", path);

        states.append("title")
            .text(d => d.properties.name);

        g.append("path")
            .attr("fill", "none")
            .attr("stroke", "white")
            .attr("stroke-linejoin", "round")
            .attr("d", path(topojson.mesh(us, us.objects.states, (a, b) => a !== b)));
        svg.call(zoom);

        // for (const d of data) {
        //     g.append("circle")
        //         .attr("transform", `translate(${d.projection})`)
        //         .attr("r", 3)
        //         .attr("fill-opacity", 1)
        //         .attr("stroke-opacity", 0)
        //       .transition()
        //         .attr("fill-opacity", 0)
        //         .attr("stroke-opacity", 1);
        // }

        function reset() {
          states.transition().style("fill", null);
          svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity,
            d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
          );

          $('#search_box').val("")
          search_box_text = ""
          selected_state = ""
          selected_point = ""

          chartsDataJoin(college_mobility);

        }

        function clicked(event, d) {
          const [[x0, y0], [x1, y1]] = path.bounds(d);
          event.stopPropagation();
          states.transition().style("fill", null);


          selected_state = this.__data__.properties.name

          console.log("SELECTED_POINT")
          console.log(selected_point)

          if (selected_point) {
            if (selected_point.state_name != selected_state) {
              $("#school-label").text("None")
              $("#tier-label").text("None")
              $("#state-label").text(selected_state)
              selected_point = null;
            }

          } else {
            $("#school-label").text("None")
            $("#tier-label").text("None")
            $("#state-label").text(selected_state)
          }

          chartsDataJoin(college_mobility.filter(d => filter_searchbox(d) && filter_state(d)))

          d3.select(this).transition().style("fill", "black");
          svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity
              .translate(width / 2, height / 2)
              .scale(Math.min(8, 0.9 / Math.max((x1 - x0) / width, (y1 - y0) / height)))
              .translate(-(x0 + x1) / 2, -(y0 + y1) / 2),
            d3.pointer(event, svg.node())
          );

          console.log(this)
        }

        function zoomed(event) {
          const {transform} = event;
          // console.log("ZOOM EVENT")
          // console.log(event)
          g.attr("transform", transform);
          g.selectAll('circle').attr('r', function (d, i)
            {zoom_factor = event.transform.k
             if (d3.select(this).attr('fill-opacity') == 1)
                return big_r / Math.sqrt(zoom_factor);
             return small_r / Math.sqrt(zoom_factor);})

        }

        const colorScaleTier = d3.scaleOrdinal()
          .domain(college_mobility.map(d => d.tier_name))
          .range(d3.schemeTableau10); // try other schemes, too!

        const colorScaleMobilityGradient = d3.scaleLinear()
            .domain([d3.min(college_mobility, d => d.kq5_cond_parq1),
                     d3.median(college_mobility, d => d.kq5_cond_parq1),
                     d3.max(college_mobility, d => d.kq5_cond_parq1)])
            .range(['#d73027', '#ffffbf', '#1a9850']);
            // .range(['red', '#ddd', 'blue']);


        //*********************************************************************
        // Draw our histogram
        const width_histo = 300,
              height_histo = 150,
              margin_histo = {top: 10, right: 0, bottom: 20, left: 80};

        const svg_histo_tier = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_histo_tier = (data) => d3.rollups(
          data,
          vals => vals.length,
          d => d.tier_name
        ).map(d => ({key: d[0], value: d[1]}));

        const rawAggregateTier = aggregate_histo_tier(college_mobility);

        // console.log(rawAggregateTier)

        const xScale_histo_tier = d3.scaleLinear()
          .domain([0, d3.max(rawAggregateTier, d => d.value)])
          .range([margin_histo.left, width_histo - margin_histo.right])
          .nice();

        const yScale_histo_tier = d3.scaleBand()
          .domain(rawAggregateTier.map(d => d.key))
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .padding(0.1);

        svg_histo_tier.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_histo_tier).ticks(3));

        svg_histo_tier.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_histo_tier).tickFormat((d,i) => d));

        const g_hist_tier = svg_histo_tier.append('g')
          .classed('marks', true);

        //histogram datajoin
        function dataJoinHistoTier(rawData = college_mobility) {
          const data = aggregate_histo_tier(rawData);
          // console.log(data);

          g_hist_tier.selectAll('rect')
            .data(data)
            .join(
              enter => enter.append("rect")
                  .attr("fill", d => colorScaleTier(d.key))
                  .attr('x', margin_histo.left)
                  .attr('y', d => yScale_histo_tier(d.key))
                  .attr('height', yScale_histo_tier.bandwidth())
                .call(enter => enter.transition().duration(1000)
                  .attr('width', d => {
                    // console.log(d.value);
                    return xScale_histo_tier(d.value) - margin_histo.left})),
              update => update
                  .attr("fill", d => colorScaleTier(d.key))
                  .attr('y', d => yScale_histo_tier(d.key))
                  // .attr('width', d => xScale_histo_tier(d.value) - margin_histo.left),
                .call(update => update.transition().duration(200)
                  .attr('width', d => xScale_histo_tier(d.value) - margin_histo.left)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => xScale_histo_tier(0) - margin_histo.left)
                  .remove())
            );

        }

        //-------------------------------------------------------------------------


        const svg_histo_mobility = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_histo_mobility = (data) => {



          return [
            ["Tier Avg",
             selected_point ?
              d3.mean(college_mobility.filter(d => d.tier_name == selected_point.tier_name),
                      d => d.kq5_cond_parq1) :
              0],
            ["State Avg",
             selected_point ?
              d3.mean(college_mobility.filter(d => d.state_name == selected_point.state_name),
                      d => d.kq5_cond_parq1) :
              selected_state ?
                d3.mean(college_mobility.filter(d => d.state_name == selected_state),
                        d => d.kq5_cond_parq1) :
                0],
            ["US Avg", d3.mean(college_mobility, d => d.kq5_cond_parq1)]

          ].map(d => ({key: d[0], value: d[1]}))
      };

        const rawAggregateMobility = aggregate_histo_mobility(college_mobility);

        // console.log(rawAggregateMobility)

        const yScale_histo_mobility = d3.scaleLinear()
          .domain([0, 100])
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .nice();

        // console.log(yScale_histo_mobility(10))
        // console.log(yScale_histo_mobility(20))

        const xScale_histo_mobility = d3.scaleBand()
          .domain(rawAggregateMobility.map(d => d.key))
          .range([margin_histo.left, width_histo - margin_histo.right])
          .padding(0.1);

        svg_histo_mobility.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_histo_mobility).tickFormat((d,i) => d));

        svg_histo_mobility.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_histo_mobility).ticks(4))
          .append('text')
            .attr('transform', `translate(-30, ${margin_histo.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text('Social Mobility');

        const g_hist_mobility = svg_histo_mobility.append('g')
          .classed('marks', true);

        //histogram datajoin
        function dataJoinHistoMobility(rawData = college_mobility) {
          const data = aggregate_histo_mobility(rawData);

          // console.log(data)

          g_hist_mobility.selectAll("line").remove()


          if (selected_point) {
            console.log(selected_point.kq5_cond_parq1)
            g_hist_mobility.append("svg:line")
              .attr("class", 'd3-dp-line')
              .attr("x1", margin_histo.left)
              .attr("y1", yScale_histo_mobility(selected_point.kq5_cond_parq1))
              .attr("x2", width_histo - margin_histo.right)
              .attr("y2", yScale_histo_mobility(selected_point.kq5_cond_parq1))
              .style("stroke-dasharray", ("3, 3"))
              .style("stroke-opacity", 1)
              .style("stroke-width", 2)
              .style("stroke", "#ff7c43");
          }

          g_hist_mobility.selectAll('rect')
            .data(data)
            .join(
              enter => enter.append("rect")
                  .attr("fill", "#2f4b7c")
                  .attr('x', d => xScale_histo_mobility(d.key))
                  .attr('y', d => yScale_histo_mobility(d.value))
                  .attr('height', d => yScale_histo_mobility(0) - yScale_histo_mobility(d.value))
                .call(enter => enter.transition().duration(1000))
                  .attr('width', d => xScale_histo_mobility.bandwidth()),
              update => update
                .attr('x', d => xScale_histo_mobility(d.key))
                .attr('y', d => yScale_histo_mobility(d.value))
                .attr('height', d => yScale_histo_mobility(0) - yScale_histo_mobility(d.value))
              .call(enter => enter.transition().duration(1000)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => yScale_histo_mobility(0) - margin_histo.left)
                  .remove())
            );

        }







        //*********************************************************************

        //-------------------------------------------------------------------------

        const svg_histo_race = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_histo_race = (data) => {


          console.log("selected Point")
          if(selected_point){
            console.log(college_mobility.filter(d => d.name == selected_point.name).asian_or_pacific_share_fall_2000)

          }

          return [
            ["Asian",
             selected_point ?

              college_mobility.filter(d => d.name == selected_point.name).map(d => d.asian_or_pacific_share_fall_2000) :
              0],
            ["Black",
             selected_point ?
              college_mobility.filter(d => d.name == selected_point.name).map(d => d.black_share_fall_2000) :
              0],

            ["Hispanic",
             selected_point ?
              college_mobility.filter(d => d.name == selected_point.name).map(d => d.hisp_share_fall_2000) :
              0],
            ["Alien",
             selected_point ?
              college_mobility.filter(d => d.name == selected_point.name).map(d => d.alien_share_fall_2000) :
              0]

          ].map(d => ({key: d[0], value: d[1]}))
      };

        const rawAggregateRace = aggregate_histo_race(college_mobility);

        //console.log(rawAggregateRace)

        const yScale_histo_race = d3.scaleLinear()
          .domain([0, 1])
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .nice();

        // // console.log(yScale_histo_mobility(10))
        // // console.log(yScale_histo_mobility(20))

        const xScale_histo_race = d3.scaleBand()
          .domain(rawAggregateRace.map(d => d.key))
          .range([margin_histo.left, width_histo - margin_histo.right])
          .padding(0.1);

        svg_histo_race.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_histo_race).tickFormat((d,i) => d));

        svg_histo_race.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_histo_race).ticks(4))
          .append('text')
            .attr('transform', `translate(-30, ${margin_histo.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text('Race Demographics');

        const g_hist_race = svg_histo_race.append('g')
          .classed('marks', true);

        // //histogram datajoin
        function dataJoinHistoRace(rawData = college_mobility) {
          const data = aggregate_histo_race(rawData);
          console.log("hi")
          console.log(data)

          g_hist_race.selectAll("line").remove()
          g_hist_race.selectAll('rect')
            .data(data)
            .join(
              enter => enter.append("rect")
                  .attr("fill", "#2f4b7c")
                  .attr('x', d => xScale_histo_race(d.key))
                  .attr('y', d => yScale_histo_race(d.value))
                  .attr('height', d => yScale_histo_race(0) - yScale_histo_race(d.value))
                .call(enter => enter.transition().duration(1000))
                  .attr('width', d => xScale_histo_race.bandwidth()),
              update => update
                .attr('x', d => xScale_histo_race(d.key))
                .attr('y', d => yScale_histo_race(d.value))
                .attr('height', d => yScale_histo_race(0) - yScale_histo_race(d.value))
              .call(enter => enter.transition().duration(1000)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => yScale_histo_race(0) - margin_histo.left)
                  .remove())
            );

        }









        //*********************************************************************

        //-------------------------------------------------------------------------
        const svg_histo_major = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_histo_major = (data) => {

          return [
            ["Art",
             selected_point ?

              college_mobility.filter(d => d.name == selected_point.name).map(d => d.pct_arthuman_2000) :
              0],
            ["Business",
             selected_point ?
              college_mobility.filter(d => d.name == selected_point.name).map(d => d.pct_business_2000) :
              0],

            ["Health",
             selected_point ?
              college_mobility.filter(d => d.name == selected_point.name).map(d => d.pct_health_2000) :
              0],

            ["Stem",
             selected_point ?
              college_mobility.filter(d => d.name == selected_point.name).map(d => d.pct_stem_2000) :
              0]


          ].map(d => ({key: d[0], value: d[1]}))
      };

        const rawAggregateMajor = aggregate_histo_major(college_mobility);

        //console.log(rawAggregateRace)

        const yScale_histo_major = d3.scaleLinear()
          .domain([0, 100])
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .nice();

        // // console.log(yScale_histo_mobility(10))
        // // console.log(yScale_histo_mobility(20))

        const xScale_histo_major = d3.scaleBand()
          .domain(rawAggregateMajor.map(d => d.key))
          .range([margin_histo.left, width_histo - margin_histo.right])
          .padding(0.1);

        svg_histo_major.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_histo_major).tickFormat((d,i) => d));

        svg_histo_major.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_histo_race).ticks(4))
          .append('text')
            .attr('transform', `translate(-30, ${margin_histo.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text('Major Demographics');

        const g_hist_major = svg_histo_major.append('g')
          .classed('marks', true);

        // //histogram datajoin
        function dataJoinHistoMajor(rawData = college_mobility) {
          const data = aggregate_histo_major(rawData);
          g_hist_major.selectAll("line").remove()
          g_hist_major.selectAll('rect')
            .data(data)
            .join(
              enter => enter.append("rect")
                  .attr("fill", "#2f4b7c")
                  .attr('x', d => xScale_histo_major(d.key))
                  .attr('y', d => yScale_histo_major(d.value))
                  .attr('height', d => yScale_histo_major(0) - yScale_histo_major(d.value))
                .call(enter => enter.transition().duration(1000))
                  .attr('width', d => xScale_histo_major.bandwidth()),
              update => update
                .attr('x', d => xScale_histo_major(d.key))
                .attr('y', d => yScale_histo_major(d.value))
                .attr('height', d => yScale_histo_major(0) - yScale_histo_major(d.value))
              .call(enter => enter.transition().duration(1000)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => yScale_histo_major(0) - margin_histo.left)
                  .remove())
            );

        }
        //*********************************************************************

        //-------------------------------------------------------------------------


        const svg_histo_stickerprice = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_histo_stickerprice = (data) => {

          return [
            ["Tier Avg",
             selected_point ?
              d3.mean(college_mobility.filter(d => d.tier_name == selected_point.tier_name),
                      d => d.sticker_price_2013) :
              0],
            ["State Avg",
             selected_point ?
              d3.mean(college_mobility.filter(d => d.state_name == selected_point.state_name),
                      d => d.sticker_price_2013) :
              selected_state ?
                d3.mean(college_mobility.filter(d => d.state_name == selected_state),
                        d => d.sticker_price_2013) :
                0],
            ["US Avg", d3.mean(college_mobility, d => d.sticker_price_2013)]

          ].map(d => ({key: d[0], value: d[1]}))
      };

        const rawAggregateStickerprice = aggregate_histo_stickerprice(college_mobility);

        // console.log(rawAggregateStickerprice)

        const yScale_histo_stickerprice = d3.scaleLinear()
          .domain([0, 52000])
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .nice();

        console.log(d3.max(college_mobility, d => d.sticker_price_2013))

        // console.log(yScale_histo_stickerprice(10))
        // console.log(yScale_histo_stickerprice(20))

        const xScale_histo_stickerprice = d3.scaleBand()
          .domain(rawAggregateStickerprice.map(d => d.key))
          .range([margin_histo.left, width_histo - margin_histo.right])
          .padding(0.1);

        svg_histo_stickerprice.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_histo_stickerprice).tickFormat((d,i) => d));

        svg_histo_stickerprice.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_histo_stickerprice).ticks(4))
          .append('text')
            .attr('transform', `translate(-50, ${margin_histo.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text('Sticker Price (2013)');

        const g_hist_stickerprice = svg_histo_stickerprice.append('g')
          .classed('marks', true);

        //histogram datajoin
        function dataJoinHistoStickerprice(rawData = college_mobility) {
          const data = aggregate_histo_stickerprice(rawData);

          // console.log(data)

          g_hist_stickerprice.selectAll("line").remove()


          if (selected_point) {
            console.log(selected_point.sticker_price_2013)
            g_hist_stickerprice.append("svg:line")
              .attr("class", 'd3-dp-line')
              .attr("x1", margin_histo.left)
              .attr("y1", yScale_histo_stickerprice(selected_point.sticker_price_2013))
              .attr("x2", width_histo - margin_histo.right)
              .attr("y2", yScale_histo_stickerprice(selected_point.sticker_price_2013))
              .style("stroke-dasharray", ("3, 3"))
              .style("stroke-opacity", 1)
              .style("stroke-width", 2)
              .style("stroke", "#ff7c43");
          }

          g_hist_stickerprice.selectAll('rect')
            .data(data)
            .join(
              enter => enter.append("rect")
                  .attr("fill", "#2f4b7c")
                  .attr('x', d => xScale_histo_stickerprice(d.key))
                  .attr('y', d => yScale_histo_stickerprice(d.value))
                  .attr('height', d => yScale_histo_stickerprice(0) - yScale_histo_stickerprice(d.value))
                .call(enter => enter.transition().duration(1000))
                  .attr('width', d => xScale_histo_stickerprice.bandwidth()),
              update => update
                .attr('x', d => xScale_histo_stickerprice(d.key))
                .attr('y', d => yScale_histo_stickerprice(d.value))
                .attr('height', d => yScale_histo_stickerprice(0) - yScale_histo_stickerprice(d.value))
              .call(enter => enter.transition().duration(1000)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => yScale_histo_stickerprice(0) - margin_histo.left)
                  .remove())
            );

        }








        //*********************************************************************

        //-------------------------------------------------------------------------


        const svg_histo_parentincome = d3.create('svg')
          .attr('width', width_histo)
          .attr('height', height_histo);

        // Helper function to nicely aggregate the data to plot on the histogram
        // output: [{key: 0, value: 495927174}, {key: 1, value: 355392405}, ...{key: 5, value: 854125031}]
        const aggregate_histo_parentincome = (data) => {

          return [
            ["Tier Avg",
             selected_point ?
              d3.mean(college_mobility.filter(d => d.tier_name == selected_point.tier_name),
                      d => d.par_median) :
              0],
            ["State Avg",
             selected_point ?
              d3.mean(college_mobility.filter(d => d.state_name == selected_point.state_name),
                      d => d.par_median) :
              selected_state ?
                d3.mean(college_mobility.filter(d => d.state_name == selected_state),
                        d => d.par_median) :
                0],
            ["US Avg", d3.mean(college_mobility, d => d.par_median)]

          ].map(d => ({key: d[0], value: d[1]}))
      };

        const rawAggregateParentincome = aggregate_histo_parentincome(college_mobility);

        // console.log(rawAggregateParentincome)

        const yScale_histo_parentincome = d3.scaleLinear()
          .domain([0, 230000])
          .range([height_histo - margin_histo.bottom, margin_histo.top])
          .nice();

        console.log(d3.max(college_mobility, d => d.par_median))

        // console.log(yScale_histo_parentincome(10))
        // console.log(yScale_histo_parentincome(20))

        const xScale_histo_parentincome = d3.scaleBand()
          .domain(rawAggregateParentincome.map(d => d.key))
          .range([margin_histo.left, width_histo - margin_histo.right])
          .padding(0.1);

        svg_histo_parentincome.append('g')
          .classed('x-axis', true)
          .attr('transform', `translate(0, ${height_histo - margin_histo.bottom})`)
          .call(d3.axisBottom(xScale_histo_parentincome).tickFormat((d,i) => d));

        svg_histo_parentincome.append('g')
          .classed('y-axis', true)
          .attr('transform', `translate(${margin_histo.left}, 0)`)
          .call(d3.axisLeft(yScale_histo_parentincome).ticks(4))
          .append('text')
            .attr('transform', `translate(-50, ${margin_histo.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', 'black')
            .attr('font-size', '12px')
            .attr('font-weight', 'bold')
            .text('Median Parent Income');

        const g_hist_parentincome = svg_histo_parentincome.append('g')
          .classed('marks', true);

        //histogram datajoin
        function dataJoinHistoParentincome(rawData = college_mobility) {
          const data = aggregate_histo_parentincome(rawData);

          console.log(data)

          g_hist_parentincome.selectAll("line").remove()


          if (selected_point) {
            console.log(selected_point.par_median)
            g_hist_parentincome.append("svg:line")
              .attr("class", 'd3-dp-line')
              .attr("x1", margin_histo.left)
              .attr("y1", yScale_histo_parentincome(selected_point.par_median))
              .attr("x2", width_histo - margin_histo.right)
              .attr("y2", yScale_histo_parentincome(selected_point.par_median))
              .style("stroke-dasharray", ("3, 3"))
              .style("stroke-opacity", 1)
              .style("stroke-width", 2)
              .style("stroke", "#ff7c43");
          }

          g_hist_parentincome.selectAll('rect')
            .data(data)
            .join(
              enter => enter.append("rect")
                  .attr("fill", "#2f4b7c")
                  .attr('x', d => xScale_histo_parentincome(d.key))
                  .attr('y', d => yScale_histo_parentincome(d.value))
                  .attr('height', d => yScale_histo_parentincome(0) - yScale_histo_parentincome(d.value))
                .call(enter => enter.transition().duration(1000))
                  .attr('width', d => xScale_histo_parentincome.bandwidth()),
              update => update
                .attr('x', d => xScale_histo_parentincome(d.key))
                .attr('y', d => yScale_histo_parentincome(d.value))
                .attr('height', d => yScale_histo_parentincome(0) - yScale_histo_parentincome(d.value))
              .call(enter => enter.transition().duration(1000)),
              exit => exit
                .call(exit => exit.transition().duration(1000)
                  .attr('width', d => yScale_histo_parentincome(0) - margin_histo.left)
                  .remove())
            );

        }








        //*********************************************************************


        // svg.append("g")
        //   .attr("class", "legendLinear")
        //   .attr("transform", "translate(20,20)");
        //
        // var legendLinear = d3.legendColor()
        //   .shapeWidth(30)
        //   .cells(10)
        //   .orient('horizontal')
        //   .scale(colorScaleMobilityGradient);
        //
        // svg.select(".legendLinear")
        //   .call(legendLinear);

        //scatter plot datajoin
        function dataJoinMap(rawData = college_mobility) {
            const data = rawData//.filter(d => d.year === year);

            function displayTooltipAndRightCharts(e, d) {
              tip_div.transition()
                .duration(200)
                .style("opacity", .8);
              tip_div.text(d.name)
                .style("left", (e.pageX) + "px")
                .style("top", (e.pageY - 28) + "px");

              $("#school-label").text(d.name)
              $("#tier-label").text(d.tier_name)
              $("#state-label").text(d.state_name)


              // $('.RaceDemographics').show()
              // $('.MajorDist').show()

            }

            function hideTooltipAndRightCharts(e, d) {
              tip_div.transition()
                 .duration(500)
                 .style("opacity", 0);

             // $("#school-label").text("None")
             // $("#tier-label").text("None")
             // $("#state-label").text(selected_state ? selected_state : "")

              // $('.RaceDemographics').hide()
              // $('.MajorDist').hide()


            }

            // TODO: Selected on mouseover

            g.selectAll("circle")
                .data(data)
                .join(
                  enter => enter.append("circle")
                    .attr("transform", d => `translate(${d.projection})`)
                    .attr("r", big_r / Math.sqrt(zoom_factor))
                    .attr("fill", d => colorScaleMobilityGradient(d.kq5_cond_parq1))
                    .attr("stroke", d => colorScaleMobilityGradient(d.kq5_cond_parq1))
                    .attr("fill-opacity", 1)
                    .attr("stroke-opacity", 0)
                    .raise()
                    .on("mouseover", function(e, d) {
                        selected_point = d
                      	displayTooltipAndRightCharts(e, d)
                        dataJoinBarplots()
                  	})
                    .on("mouseout", function(e, d) {
                        // selected_point = null
                        hideTooltipAndRightCharts(e, d)
                        // dataJoinBarplots()
                    }).raise(),

                  update => update
                    .attr("transform", d => `translate(${d.projection})`)
                    .attr("r", big_r / Math.sqrt(zoom_factor))
                    .attr("fill", d => colorScaleMobilityGradient(d.kq5_cond_parq1))
                    .attr("stroke", d => colorScaleMobilityGradient(d.kq5_cond_parq1))
                    .attr("stroke-opacity", 0)
                    .attr("fill-opacity", 1)
                    .on("mouseover", function(e, d) {
                      displayTooltipAndRightCharts(e, d)
                      selected_point = d
                      dataJoinBarplots()

                    })
                    .on("mouseout", function(e, d) {
                        hideTooltipAndRightCharts(e, d)
                        selected_point = null
                        dataJoinBarplots()
                    }),

                  exit => {return exit
                    // .attr("fill", "gray")
                    // .attr("stroke", "gray")
                    .attr("fill-opacity", 0)
                    .attr("stroke-opacity", .5)
                    .attr("r", small_r / Math.sqrt(zoom_factor))
                    .on("mouseover", null)
                    .on("mouseout", null)})

                  // Raise visible points
                  g.selectAll("circle").filter(function() {return d3.select(this).attr("fill-opacity") == 1}).raise()



        }


        function dataJoinBarplots(rawData = college_mobility) {
          dataJoinHistoTier(rawData);
          dataJoinHistoMobility(rawData);
          dataJoinHistoStickerprice(rawData);
          dataJoinHistoParentincome(rawData);
          dataJoinHistoRace(rawData);
          dataJoinHistoMajor(rawData);

        }


        // Helper to draw both the scatter plot and the histogram
        function chartsDataJoin(rawData = college_mobility) {
          dataJoinMap(rawData);
          dataJoinBarplots(rawData);

        };

        chartsDataJoin();


        $('#search_box').autocomplete({
          // source: college_mobility.map(d => d.name)
          source: function (request, response) {
                      response(college_mobility
                        .filter(d => filter_searchbox(d) & filter_state(d))
                        .map(d => d.name))
                  }
        });

        $('#search_box').keyup(function(e){
          // $('#slider').slider({value: this.value});

          // console.log(this.value);

          search_box_text = this.value

          if (e.which == '13') {
            // e.preventDefault();

            let results = college_mobility.filter(d => filter_searchbox(d) && filter_state(d))

            console.log("ENTERPRESSED")

            if (results.length == 1) {
              console.log("RESULT")
              console.log(results)
              selected_point = results[0]

              $("#school-label").text(selected_point.name)
              $("#tier-label").text(selected_point.tier_name)
              $("#state-label").text(selected_point.state_name)

              chartsDataJoin(results)

            }


          } else {

            dataJoinMap(college_mobility.filter(d => filter_searchbox(d) && filter_state(d)));

            let results = college_mobility.filter(d => filter_searchbox(d) && filter_state(d))

            console.log("ENTERPRESSED")

            if (results.length == 1) {
              console.log("RESULT")
              console.log(results)
              selected_point = results[0]

              $("#school-label").text(selected_point.name)
              $("#tier-label").text(selected_point.tier_name)
              $("#state-label").text(selected_point.state_name)

              chartsDataJoin(results)

            }
          }

        });

        // $('#search_button').click(function(){
        //   // $('#slider').slider({value: this.value});
        //
        //   // console.log(this.value);
        //
        //   console.log("SEARCH CLICKED");
        //
        //   chartsDataJoin(college_mobility.filter(d => filter_searchbox(d) && filter_state(d)));
        // });

        $('#reset_button').click(function(){
          // $('#slider').slider({value: this.value});

          // console.log(this.value);

          console.log("RESET CLICKED");

          reset()

        });




        $('.Map').append(svg.node());

        //add the histogram below the graph
        // $('.RaceDemographics').append(svg_histo_tier.node());
        $('.RaceDemographics').append(svg_histo_race.node());
        $('.MajorDist').append(svg_histo_major.node());
        // $('.MajorDist').append(svg_histo_mobility.node());
        $('.SocialMobility').append(svg_histo_mobility.node());
        $('.StickerPrice').append(svg_histo_stickerprice.node());
        $('.ParentsIncome').append(svg_histo_parentincome.node());


      });

      </script>
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>
